<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Automating Container Builds with GitHub Actions for Upstream Changes" /><meta name="author" content="Corey Callaway" /><meta property="og:locale" content="en" /><meta name="description" content="Automating container builds with GitHub Actions when the upstream image changes." /><meta property="og:description" content="Automating container builds with GitHub Actions when the upstream image changes." /><link rel="canonical" href="https://cocallaw.com/posts/Automating-Container-Builds-for-Upstream-Changes/" /><meta property="og:url" content="https://cocallaw.com/posts/Automating-Container-Builds-for-Upstream-Changes/" /><meta property="og:site_name" content="cocallaw" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2025-05-05T09:00:00-04:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Automating Container Builds with GitHub Actions for Upstream Changes" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@Corey Callaway" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Corey Callaway","url":"https://www.cocallaw.com/about/"},"dateModified":"2025-05-05T09:00:00-04:00","datePublished":"2025-05-05T09:00:00-04:00","description":"Automating container builds with GitHub Actions when the upstream image changes.","headline":"Automating Container Builds with GitHub Actions for Upstream Changes","mainEntityOfPage":{"@type":"WebPage","@id":"https://cocallaw.com/posts/Automating-Container-Builds-for-Upstream-Changes/"},"url":"https://cocallaw.com/posts/Automating-Container-Builds-for-Upstream-Changes/"}</script><title>Automating Container Builds with GitHub Actions for Upstream Changes | cocallaw</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="cocallaw"><meta name="application-name" content="cocallaw"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=true" ></script> <script defer src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon='{"token": "b814618bb529402badb6aeea52009c22"}' ></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="https://ccblog-hxegfte6cpg4c7a3.z01.azurefd.net/general/profile.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">cocallaw</a><p class="site-subtitle fst-italic mb-0">Azure Tinkerings</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/cocallaw" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://www.linkedin.com/in/corey-callaway-1abbb227/" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Automating Container Builds with GitHub Actions for Upstream Changes</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link" aria-label="Search"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>Automating Container Builds with GitHub Actions for Upstream Changes</h1><p class="post-desc fw-light mb-4">Automating container builds with GitHub Actions when the upstream image changes.</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1746450000" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > May 5, 2025 </time> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://www.cocallaw.com/about/">Corey Callaway</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="1495 words" > <em>8 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">Automating Container Builds with GitHub Actions for Upstream Changes</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">Automating Container Builds with GitHub Actions for Upstream Changes</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><p>Keeping your container images up to date is crucial for security and performance. Whether you’re running a homelab or managing production workloads, you want to ensure that your containers are built with the latest upstream changes. However, manually keeping track of updates and rebuilding containers can be tedious.</p><p>I use <a href="https://tailscale.com/">Tailscale</a> to easily access services I run at home, or to easily connect to a lab environment in Azure from wherever I may be. To make this easier, I extended the Tailscale container image so I could deploy it as a <a href="https://github.com/cocallaw/terraform-azure-tailscale-subnet-router">subnet router</a> and inject the address ranges that I needed advertised to my Tailnet. This made my setup more resilient, but I still had to make sure my container was using the latest version of Tailscale to make sure I was secure and prevent possible issues.</p><p>Until recently, I had a simple <a href="https://docs.github.com/en/actions">GitHub Actions</a> workflow that would build and push to Docker Hub, whenever I remembered to check for updates (which I didn’t do very regularly) to the upstream Tailscale image.</p><p>In this post, I’ll walk through how I use a GitHub Actions workflow to <strong>automatically check for updates to an upstream Docker image</strong>, and <strong>trigger a build and push only if a new version is available</strong>. This kind of automation saves time, reduces human error, and keeps my environment reliably up to date.</p><h2 id="why-automate-container-builds"><span class="me-2">Why Automate Container Builds?</span><a href="#why-automate-container-builds" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>If you’re maintaining a custom container that wraps or extends functionality from an upstream project (like Tailscale, Nginx, or Node.js), you’ll often want to:</p><ul><li>Track upstream releases.<li>Rebuild your container with the new version.<li>Push the updated image to Docker Hub or a private registry.<li>Optionally commit a version change back to your repo for tracking.</ul><p>Doing all this manually is inefficient. Automating this with GitHub Actions ensures consistency and frees you to focus on more important tasks.</p><h2 id="the-workflow"><span class="me-2">The Workflow</span><a href="#the-workflow" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Here’s a breakdown of the GitHub Actions workflow I use. It:</p><ul><li>Runs every 3 days or on manual trigger.<li>Checks the latest stable tag of the upstream container.<li>Compares it against images already published.<li>If a newer version is available, builds and pushes multi-arch images.<li>Commits a version file update for visibility.</ul><h2 id="secrets-you-will-need"><span class="me-2">Secrets You Will Need</span><a href="#secrets-you-will-need" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Before you can use this workflow, you’ll need to set up a few secrets in your GitHub repository to allow the workflow to authenticate with Docker Hub. The workflow uses a <a href="https://docs.docker.com/security/for-developers/access-tokens/">Docker Hub username and an access token</a> for authentication.</p><ul><li><code class="language-plaintext highlighter-rouge">DOCKERHUB_USERNAME</code>: Your Docker Hub username.<li><code class="language-plaintext highlighter-rouge">DOCKERHUB_TOKEN</code>: A Docker Hub access token with write permissions.</ul><p>To set these secrets, go to your GitHub repository, click on <strong>Settings</strong>, then <strong>Secrets and variables</strong> &gt; <strong>Actions</strong>. Click on <strong>New repository secret</strong> to add each secret.</p><h2 id="workflow-breakdown"><span class="me-2">Workflow Breakdown</span><a href="#workflow-breakdown" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Let’s walk through what each section of the workflow does and how it contributes to the build and update process.</p><h3 id="1-triggers"><span class="me-2">1. Triggers</span><a href="#1-triggers" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="na">on</span><span class="pi">:</span>
  <span class="na">schedule</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">cron</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">*/3</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*'</span>
  <span class="na">workflow_dispatch</span><span class="pi">:</span>
</pre></table></code></div></div><ul><li><strong><code class="language-plaintext highlighter-rouge">schedule</code></strong>: Runs the workflow automatically every 3 days.<li><strong><code class="language-plaintext highlighter-rouge">workflow_dispatch</code></strong>: Allows you to manually trigger the workflow from the GitHub UI.</ul><h3 id="2-permissions"><span class="me-2">2. Permissions</span><a href="#2-permissions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="na">permissions</span><span class="pi">:</span>
  <span class="na">contents</span><span class="pi">:</span> <span class="s">write</span>
</pre></table></code></div></div><p>This grants the workflow permission to make commits to the repository, which is necessary so that the <code class="language-plaintext highlighter-rouge">upstream-version.txt</code> file can be updated and pushed to the repo if there is a new upstream container version.</p><h3 id="3-job-check-and-build"><span class="me-2">3. Job: <code class="language-plaintext highlighter-rouge">check-and-build</code></span><a href="#3-job-check-and-build" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The entire automation is contained in a single job that runs using the latest Ubuntu GitHub Actions runner.</p><h4 id="step-checkout-repo"><span class="me-2">Step: Checkout Repo</span><a href="#step-checkout-repo" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="na">jobs</span><span class="pi">:</span>
  <span class="na">check-and-build</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>

    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout repo</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v3</span>
</pre></table></code></div></div><p>This pulls down the repository code so that subsequent steps can read/write files like <code class="language-plaintext highlighter-rouge">upstream-version.txt</code> and the <code class="language-plaintext highlighter-rouge">Dockerfile</code>.</p><h4 id="step-get-latest-upstream-version"><span class="me-2">Step: Get Latest Upstream Version</span><a href="#step-get-latest-upstream-version" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Get latest Tailscale stable version</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">tailscale</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">VERSION=$(curl -s https://registry.hub.docker.com/v2/repositories/tailscale/tailscale/tags/?page_size=100 \</span>
            <span class="s">| jq -r '.results[].name' \</span>
            <span class="s">| grep -E '^v[0-9]+\.[0-9]+(\.[0-9]+)?$' \</span>
            <span class="s">| sort -V \</span>
            <span class="s">| tail -n1)</span>
          <span class="s">echo "Latest stable version: $VERSION"</span>
          <span class="s">echo "version=$VERSION" &gt;&gt; "$GITHUB_OUTPUT"</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Debug version</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">echo "Detected Tailscale version: ${{ steps.tailscale.outputs.version }}"</span>
</pre></table></code></div></div><ul><li>Uses Docker Hub’s API to fetch the latest stable tag from an upstream image.<li>Outputs the latest version as <code class="language-plaintext highlighter-rouge">steps.upstream.outputs.version</code>.</ul><h4 id="step-check-for-existing-image"><span class="me-2">Step: Check for Existing Image</span><a href="#step-check-for-existing-image" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Check if image with version already exists</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">check</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">if docker manifest inspect ${{ secrets.DOCKERHUB_USERNAME }}/tailscale-sr:${{ steps.tailscale.outputs.version }} &gt; /dev/null 2&gt;&amp;1; then</span>
            <span class="s">echo "Image already exists. Skipping build."</span>
            <span class="s">echo "build_needed=false" &gt;&gt; $GITHUB_OUTPUT</span>
          <span class="s">else</span>
            <span class="s">echo "New version. Proceeding to build."</span>
            <span class="s">echo "build_needed=true" &gt;&gt; $GITHUB_OUTPUT</span>
          <span class="s">fi</span>
</pre></table></code></div></div><ul><li>Uses <code class="language-plaintext highlighter-rouge">docker manifest inspect</code> to check whether a container image for this version already exists in your Docker Hub repo.<li>Sets a flag <code class="language-plaintext highlighter-rouge">build_needed</code> to <code class="language-plaintext highlighter-rouge">true</code> or <code class="language-plaintext highlighter-rouge">false</code>.</ul><h4 id="conditional-build-steps"><span class="me-2">Conditional Build Steps</span><a href="#conditional-build-steps" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The following steps are only run if a new version is detected, resulting in <code class="language-plaintext highlighter-rouge">build_needed</code> being set to <code class="language-plaintext highlighter-rouge">true</code>.</p><ul><li>Set up emulation support (QEMU) for building multi-architecture containers.<li>Set up Docker Buildx for advanced build features.<li>Log into Docker Hub using credentials stored in GitHub Secrets.<li>Build and push the container using the new version as a tag.</ul><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre>      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set up QEMU</span>
        <span class="na">if</span><span class="pi">:</span> <span class="s">steps.check.outputs.build_needed == 'true'</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">docker/setup-qemu-action@v2</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set up Docker Buildx</span>
        <span class="na">if</span><span class="pi">:</span> <span class="s">steps.check.outputs.build_needed == 'true'</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">docker/setup-buildx-action@v2</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Login to DockerHub</span>
        <span class="na">if</span><span class="pi">:</span> <span class="s">steps.check.outputs.build_needed == 'true'</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">docker/login-action@v2</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">username</span><span class="pi">:</span> <span class="s">${{ secrets.DOCKERHUB_USERNAME }}</span>
          <span class="na">password</span><span class="pi">:</span> <span class="s">${{ secrets.DOCKERHUB_TOKEN }}</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Build and push multi-arch container</span>
        <span class="na">if</span><span class="pi">:</span> <span class="s">steps.check.outputs.build_needed == 'true'</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">docker/build-push-action@v3</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">context</span><span class="pi">:</span> <span class="s">./docker</span>
          <span class="na">build-args</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">TAILSCALE_TAG=${{ steps.tailscale.outputs.version }}</span>
          <span class="na">platforms</span><span class="pi">:</span> <span class="s">linux/amd64,linux/arm64</span>
          <span class="na">push</span><span class="pi">:</span> <span class="kc">true</span>
          <span class="na">tags</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">${{ secrets.DOCKERHUB_USERNAME }}/tailscale-sr:latest</span>
            <span class="s">${{ secrets.DOCKERHUB_USERNAME }}/tailscale-sr:${{ steps.tailscale.outputs.version }}</span>
</pre></table></code></div></div><h4 id="step-commit-version-update"><span class="me-2">Step: Commit Version Update</span><a href="#step-commit-version-update" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Commit updated version file</span>
        <span class="na">if</span><span class="pi">:</span> <span class="s">steps.check.outputs.build_needed == 'true'</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">echo "${{ steps.tailscale.outputs.version }}" &gt; tailscale-version.txt</span>
          <span class="s">git config user.name "github-actions[bot]"</span>
          <span class="s">git config user.email "github-actions[bot]@users.noreply.github.com"</span>
          <span class="s">git add tailscale-version.txt</span>
          <span class="s">git commit -m "Update Tailscale version to ${{ steps.tailscale.outputs.version }}"</span>
          <span class="s">git push</span>
</pre></table></code></div></div><p>This writes the new version to a file, commits it, and pushes it to your GitHub repo. This gives you a version history and a way to confirm that the build occurred.</p><h2 id="the-yaml-workflow"><span class="me-2">The YAML Workflow</span><a href="#the-yaml-workflow" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
</pre><td class="rouge-code"><pre><span class="na">name</span><span class="pi">:</span> <span class="s">Auto Build &amp; Publish Tailscale Container</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">schedule</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">cron</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">*/3</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*'</span>  <span class="c1"># Every 3 days at 00:00 UTC</span>
  <span class="na">workflow_dispatch</span><span class="pi">:</span>

<span class="na">permissions</span><span class="pi">:</span>
  <span class="na">contents</span><span class="pi">:</span> <span class="s">write</span>  <span class="c1"># Needed to commit version file</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">check-and-build</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>

    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout repo</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v3</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Get latest Tailscale stable version</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">tailscale</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">VERSION=$(curl -s https://registry.hub.docker.com/v2/repositories/tailscale/tailscale/tags/?page_size=100 \</span>
            <span class="s">| jq -r '.results[].name' \</span>
            <span class="s">| grep -E '^v[0-9]+\.[0-9]+(\.[0-9]+)?$' \</span>
            <span class="s">| sort -V \</span>
            <span class="s">| tail -n1)</span>
          <span class="s">echo "Latest stable version: $VERSION"</span>
          <span class="s">echo "version=$VERSION" &gt;&gt; "$GITHUB_OUTPUT"</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Debug version</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">echo "Detected Tailscale version: ${{ steps.tailscale.outputs.version }}"</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Check if image with version already exists</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">check</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">if docker manifest inspect ${{ secrets.DOCKERHUB_USERNAME }}/tailscale-sr:${{ steps.tailscale.outputs.version }} &gt; /dev/null 2&gt;&amp;1; then</span>
            <span class="s">echo "Image already exists. Skipping build."</span>
            <span class="s">echo "build_needed=false" &gt;&gt; $GITHUB_OUTPUT</span>
          <span class="s">else</span>
            <span class="s">echo "New version. Proceeding to build."</span>
            <span class="s">echo "build_needed=true" &gt;&gt; $GITHUB_OUTPUT</span>
          <span class="s">fi</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set up QEMU</span>
        <span class="na">if</span><span class="pi">:</span> <span class="s">steps.check.outputs.build_needed == 'true'</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">docker/setup-qemu-action@v2</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set up Docker Buildx</span>
        <span class="na">if</span><span class="pi">:</span> <span class="s">steps.check.outputs.build_needed == 'true'</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">docker/setup-buildx-action@v2</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Login to DockerHub</span>
        <span class="na">if</span><span class="pi">:</span> <span class="s">steps.check.outputs.build_needed == 'true'</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">docker/login-action@v2</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">username</span><span class="pi">:</span> <span class="s">${{ secrets.DOCKERHUB_USERNAME }}</span>
          <span class="na">password</span><span class="pi">:</span> <span class="s">${{ secrets.DOCKERHUB_TOKEN }}</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Build and push multi-arch container</span>
        <span class="na">if</span><span class="pi">:</span> <span class="s">steps.check.outputs.build_needed == 'true'</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">docker/build-push-action@v3</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">context</span><span class="pi">:</span> <span class="s">./docker</span>
          <span class="na">build-args</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">TAILSCALE_TAG=${{ steps.tailscale.outputs.version }}</span>
          <span class="na">platforms</span><span class="pi">:</span> <span class="s">linux/amd64,linux/arm64</span>
          <span class="na">push</span><span class="pi">:</span> <span class="kc">true</span>
          <span class="na">tags</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">${{ secrets.DOCKERHUB_USERNAME }}/tailscale-sr:latest</span>
            <span class="s">${{ secrets.DOCKERHUB_USERNAME }}/tailscale-sr:${{ steps.tailscale.outputs.version }}</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Commit updated version file</span>
        <span class="na">if</span><span class="pi">:</span> <span class="s">steps.check.outputs.build_needed == 'true'</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">echo "${{ steps.tailscale.outputs.version }}" &gt; tailscale-version.txt</span>
          <span class="s">git config user.name "github-actions[bot]"</span>
          <span class="s">git config user.email "github-actions[bot]@users.noreply.github.com"</span>
          <span class="s">git add tailscale-version.txt</span>
          <span class="s">git commit -m "Update Tailscale version to ${{ steps.tailscale.outputs.version }}"</span>
          <span class="s">git push</span>
</pre></table></code></div></div><h2 id="final-thoughts"><span class="me-2">Final Thoughts</span><a href="#final-thoughts" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Automating container builds with GitHub Actions is a powerful way to keep your images up to date without manual intervention. This workflow can be adapted for any upstream project, and you can customize it further based on your needs.</p><ul><li>Consider adding notifications (e.g., Slack, email) to alert you when a new version is built.<li>You can also extend the workflow to run tests against the new image before pushing it.<li>Explore other GitHub Actions to enhance your CI/CD pipeline.</ul><p>If you’ve built similar automation’s or have tips for improving this setup, let me know—I’d love to hear how others are tackling this.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/github-actions/">GitHub Actions</a>, <a href="/categories/docker/">Docker</a>, <a href="/categories/automation/">Automation</a>, <a href="/categories/devops/">DevOps</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/devops/" class="post-tag no-text-decoration" >DevOps</a> <a href="/tags/automation/" class="post-tag no-text-decoration" >Automation</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fcocallaw.com%2Fposts%2FAutomating-Container-Builds-for-Upstream-Changes%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <a href="https://www.reddit.com/submit?url=https%3A%2F%2Fcocallaw.com%2Fposts%2FAutomating-Container-Builds-for-Upstream-Changes%2F&title=Automating%20Container%20Builds%20with%20GitHub%20Actions%20for%20Upstream%20Changes%20-%20cocallaw" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Reddit" aria-label="Reddit"> <i class="fa-fw fa-brands fa-square-reddit"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Automating%20Container%20Builds%20with%20GitHub%20Actions%20for%20Upstream%20Changes%20-%20cocallaw&u=https%3A%2F%2Fcocallaw.com%2Fposts%2FAutomating-Container-Builds-for-Upstream-Changes%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.threads.net/intent/post?text=Automating%20Container%20Builds%20with%20GitHub%20Actions%20for%20Upstream%20Changes%20-%20cocallaw%20https%3A%2F%2Fcocallaw.com%2Fposts%2FAutomating-Container-Builds-for-Upstream-Changes%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Threads" aria-label="Threads"> <i class="fa-fw fa-brands fa-square-threads"></i> </a> <a href="https://bsky.app/intent/compose?text=Automating%20Container%20Builds%20with%20GitHub%20Actions%20for%20Upstream%20Changes%20-%20cocallaw%20https%3A%2F%2Fcocallaw.com%2Fposts%2FAutomating-Container-Builds-for-Upstream-Changes%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Bluesky" aria-label="Bluesky"> <i class="fa-fw fa-brands fa-bluesky"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/Deploying-AVD-with-Bicep/">Deploying AVD and retrieving the Registration Token with Bicep</a><li class="text-truncate lh-lg"> <a href="/posts/Identify-Legacy-AAD-PS-Users/">Identify AzureAD PowerShell Users in your Tenant before Retirement</a><li class="text-truncate lh-lg"> <a href="/posts/Export-Bitlocker-Keys-from-Entra/">Export BitLocker Keys from Entra with Graph PowerShell</a><li class="text-truncate lh-lg"> <a href="/posts/Automating-Container-Builds-for-Upstream-Changes/">Automating Container Builds with GitHub Actions for Upstream Changes</a><li class="text-truncate lh-lg"> <a href="/posts/Creating-Confidentail-Compute-Images-from-CVMs/">Create Confidential Compute Capable Custom Images from Windows CVMs</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/images/">images</a> <a class="post-tag btn btn-outline-primary" href="/tags/microsoft-graph/">Microsoft Graph</a> <a class="post-tag btn btn-outline-primary" href="/tags/powershell/">PowerShell</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">Automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/avd/">AVd</a> <a class="post-tag btn btn-outline-primary" href="/tags/azure-virtual-desktop/">Azure Virtual Desktop</a> <a class="post-tag btn btn-outline-primary" href="/tags/azure/">Azure</a> <a class="post-tag btn btn-outline-primary" href="/tags/azuread/">AzureAD</a> <a class="post-tag btn btn-outline-primary" href="/tags/bicep/">Bicep</a> <a class="post-tag btn btn-outline-primary" href="/tags/bitlocker/">BitLocker</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/Creating-Confidentail-Compute-Images-from-CVMs/" class="btn btn-outline-primary" aria-label="Older" ><p>Create Confidential Compute Capable Custom Images from Windows CVMs</p></a> <a href="/posts/Export-Bitlocker-Keys-from-Entra/" class="btn btn-outline-primary" aria-label="Newer" ><p>Export BitLocker Keys from Entra with Graph PowerShell</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://twitter.com/username">Corey Callaway</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.3.1" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/images/">images</a> <a class="post-tag btn btn-outline-primary" href="/tags/microsoft-graph/">Microsoft Graph</a> <a class="post-tag btn btn-outline-primary" href="/tags/powershell/">PowerShell</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">Automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/avd/">AVd</a> <a class="post-tag btn btn-outline-primary" href="/tags/azure-virtual-desktop/">Azure Virtual Desktop</a> <a class="post-tag btn btn-outline-primary" href="/tags/azure/">Azure</a> <a class="post-tag btn btn-outline-primary" href="/tags/azuread/">AzureAD</a> <a class="post-tag btn btn-outline-primary" href="/tags/bicep/">Bicep</a> <a class="post-tag btn btn-outline-primary" href="/tags/bitlocker/">BitLocker</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> (function () { const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed'); const initTheme = themeMapper[Theme.visualState]; let lang = 'en';if (lang.length > 2 && !lang.startsWith('zh')) { lang = lang.slice(0, 2); } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'cocallaw/cocallaw.github.io', 'data-repo-id': 'R_kgDOMuW1lg', 'data-category': 'Giscus', 'data-category-id': 'DIC_kwDOMuW1ls4CjqPh', 'data-mapping': 'pathname', 'data-strict' : '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': lang, 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusNode = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusNode.setAttribute(key, value) ); const $footer = document.querySelector('footer'); $footer.insertAdjacentElement("beforebegin", giscusNode); addEventListener('message', (event) => { if (event.source === window && event.data && event.data.id === Theme.ID) { const newTheme = themeMapper[Theme.visualState]; const message = { setConfig: { theme: newTheme } }; const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow; giscus.postMessage({ giscus: message }, 'https://giscus.app'); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{content}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
