<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" >
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  ><!-- Setup Open Graph image -->

  

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="Create Confidential Compute Capable Custom Images from Windows CVMs" />
<meta name="author" content="Corey Callaway" />
<meta property="og:locale" content="en" />
<meta name="description" content="How to create a custom Windows image from an existing Windows CVM that can be used to provision Azure Confidential Compute VMs in Azure." />
<meta property="og:description" content="How to create a custom Windows image from an existing Windows CVM that can be used to provision Azure Confidential Compute VMs in Azure." />
<link rel="canonical" href="http://localhost:4000/posts/Creating-Confidentail-Compute-Images-from-CVMs/" />
<meta property="og:url" content="http://localhost:4000/posts/Creating-Confidentail-Compute-Images-from-CVMs/" />
<meta property="og:site_name" content="cocallaw" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-01-06T12:00:00-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Create Confidential Compute Capable Custom Images from Windows CVMs" />
<meta name="twitter:site" content="@twitter_username" />
<meta name="twitter:creator" content="@Corey Callaway" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Corey Callaway","url":"https://www.cocallaw.com/about/"},"dateModified":"2025-05-01T17:35:54-04:00","datePublished":"2025-01-06T12:00:00-05:00","description":"How to create a custom Windows image from an existing Windows CVM that can be used to provision Azure Confidential Compute VMs in Azure.","headline":"Create Confidential Compute Capable Custom Images from Windows CVMs","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/Creating-Confidentail-Compute-Images-from-CVMs/"},"url":"http://localhost:4000/posts/Creating-Confidentail-Compute-Images-from-CVMs/"}</script>
<!-- End Jekyll SEO tag -->


  <title>Create Confidential Compute Capable Custom Images from Windows CVMs | cocallaw
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">

  <link rel="manifest" href="/assets/img/favicons/site.webmanifest">

<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="cocallaw">
<meta name="application-name" content="cocallaw">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  <!-- Resource Hints -->
  
    
      
        <link rel="preconnect" href="https://fonts.googleapis.com" >
      
        <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
      
    
      
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      
        <link rel="dns-prefetch" href="https://fonts.gstatic.com" >
      
    
      
        <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      
        <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
      
    
  

  <!-- Bootstrap -->
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  

  <!-- Theme style -->
  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  <!-- Web Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.6.0/css/all.min.css">

  <!-- 3rd-party Dependencies -->

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.29.0/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Image Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css">
  

  <!-- JavaScript -->

  
    <!-- Switch the mode between dark and light. -->

<script type="text/javascript">
  class ModeToggle {
    static get MODE_KEY() {
      return 'mode';
    }
    static get MODE_ATTR() {
      return 'data-mode';
    }
    static get DARK_MODE() {
      return 'dark';
    }
    static get LIGHT_MODE() {
      return 'light';
    }
    static get ID() {
      return 'mode-toggle';
    }

    constructor() {
      let self = this;this.sysDarkPrefers.addEventListener('change', () => {
        if (self.hasMode) {
          self.clearMode();
        }
        self.notify();
      });

      if (!this.hasMode) {
        return;
      }

      if (this.isDarkMode) {
        this.setDark();
      } else {
        this.setLight();
      }
    }

    get sysDarkPrefers() {
      return window.matchMedia('(prefers-color-scheme: dark)');
    }

    get isPreferDark() {
      return this.sysDarkPrefers.matches;
    }

    get isDarkMode() {
      return this.mode === ModeToggle.DARK_MODE;
    }

    get hasMode() {
      return this.mode != null;
    }

    get mode() {
      return sessionStorage.getItem(ModeToggle.MODE_KEY);
    }get modeStatus() {
      if (this.hasMode) {
        return this.mode;
      } else {
        return this.isPreferDark ? ModeToggle.DARK_MODE : ModeToggle.LIGHT_MODE;
      }
    }

    setDark() {
      document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE);
    }

    setLight() {
      document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE);
    }

    clearMode() {
      document.documentElement.removeAttribute(ModeToggle.MODE_ATTR);
      sessionStorage.removeItem(ModeToggle.MODE_KEY);
    }notify() {
      window.postMessage(
        {
          direction: ModeToggle.ID,
          message: this.modeStatus
        },
        '*'
      );
    }

    flipMode() {
      if (this.hasMode) {
        this.clearMode();
      } else {
        if (this.isPreferDark) {
          this.setLight();
        } else {
          this.setDark();
        }
      }

      this.notify();
    }
  }

  const modeToggle = new ModeToggle();
</script>

  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle"><img src="https://ccblog-hxegfte6cpg4c7a3.z01.azurefd.net/general/profile.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a>

    <h1 class="site-title">
      <a href="/">cocallaw</a>
    </h1>
    <p class="site-subtitle fst-italic mb-0">Azure Tinkerings</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>CATEGORIES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/tags/" class="nav-link">
            <i class="fa-fw fas fa-tags"></i>
            

            <span>TAGS</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>ABOUT</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    
      <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle">
        <i class="fas fa-adjust"></i>
      </button>

      
        <span class="icon-border"></span>
      
    

    
      

      
        <a
          href="https://github.com/cocallaw"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    
      

      
        <a
          href="https://www.linkedin.com/in/corey-callaway-1abbb227/"
          aria-label="linkedin"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-linkedin"></i>
        </a>
      
    
      

      
        <a
          href="/feed.xml"
          aria-label="rss"
          

          

          

          
        >
          <i class="fas fa-rss"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">Home</a>
            </span>

          
        
          
        
          
            
              <span>Create Confidential Compute Capable Custom Images from Windows CVMs</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search id="search" class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->




  
  

  
    
      
      
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  

  


<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  




<!-- return -->




<article class="px-1">
  <header>
    <h1 data-toc-skip>Create Confidential Compute Capable Custom Images from Windows CVMs</h1>
    
      <p class="post-desc fw-light mb-4">How to create a custom Windows image from an existing Windows CVM that can be used to provision Azure Confidential Compute VMs in Azure.</p>
    

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1736182800"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Jan  6, 2025
</time>

      </span>

      <!-- lastmod date -->
      
        <span>
          Updated
          <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1746135354"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  May  1, 2025
</time>

        </span>
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              
                <a href="https://www.cocallaw.com/about/">Corey Callaway</a>
                
              
            
          </em>
        </span>

        <div>
          <!-- pageviews -->
          

          <!-- read time -->
          <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="1222 words"
>
  <em>6 min</em> read</span>

        </div>
      </div>
    </div>
  </header>

  <div class="content">
    <h2 id="confidential-compute-custom-images"><span class="me-2">Confidential Compute Custom Images</span><a href="#confidential-compute-custom-images" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>Creating a custom image from an Azure Confidential Compute VM (CVM) requires following a different process than you would for a regular Azure VM. This is due to the design of CVMs, which utilize an OS disk and a small encrypted data disk that contains the VM Guest State(VMGS) information. As a result, using the Capture button in the Azure portal or the New-AzImage command in Azure PowerShell will not produce the desired results.</p>

<p>This process to create a custom image from a CVM is necessary so that the captured image is free of and VM Guest State information and the correct properties are set for the image version and reference in a <a href="https://learn.microsoft.com/azure/virtual-machines/azure-compute-gallery">Azure Compute Gallery</a>.</p>

<p>The steps outlined below require that you have access to the Azure Subscriptions containing the resources, and the current version of both <a href="https://learn.microsoft.com/cli/azure/install-azure-cli">Azure CLI</a> and <a href="https://learn.microsoft.com/azure/storage/common/storage-use-azcopy-v10?tabs=dnf">AzCopy</a> installed. Commands were tested using Azure CLI from a Powershell Core session.</p>

<blockquote class="prompt-info">
  <p>This process to create a custom image is for an existing Windows based CVM using with Confidential OS disk encryption enabled using either PMK or CMK.</p>
</blockquote>

<h3 id="prepare-the-cvm-os-for-capture"><span class="me-2">Prepare the CVM OS for Capture</span><a href="#prepare-the-cvm-os-for-capture" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>Once the customization of the Windows OS is complete, the next step is to Disable BitLocker, wait for the decryption to complete, and then run Sysprep.</p>

<p>To disable BitLocker and check the decryption status of the OS disk, you can use the following commands in an elevated Command Prompt.</p>

<div class="language-shell highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c"># Disable BitLocker</span>
manage-bde <span class="nt">-off</span> C:

<span class="c"># Check the decryption status</span>
manage-bde <span class="nt">-status</span> C:
</pre></td></tr></tbody></table></code></div></div>

<p><a href="https://ccblog-hxegfte6cpg4c7a3.z01.azurefd.net/post-content/01-cvmcustimgcvm/manage-bde-commands.png" class="popup img-link  shimmer"><img src="https://ccblog-hxegfte6cpg4c7a3.z01.azurefd.net/post-content/01-cvmcustimgcvm/manage-bde-commands.png" alt="Manage-BDE-Commands" loading="lazy"></a></p>

<p>When the decryption status returns as Fully Decrypted, Sysprep can now be run. Selecting Generalize and Shutdown as the options.</p>

<p><a href="https://ccblog-hxegfte6cpg4c7a3.z01.azurefd.net/post-content/01-cvmcustimgcvm/sysprep-dialog.png" class="popup img-link  shimmer"><img src="https://ccblog-hxegfte6cpg4c7a3.z01.azurefd.net/post-content/01-cvmcustimgcvm/sysprep-dialog.png" alt="Sysprep-Dialog" loading="lazy"></a></p>

<h3 id="creating-the-custom-image"><span class="me-2">Creating the Custom Image</span><a href="#creating-the-custom-image" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<h4 id="collect-os-disk-information"><span class="me-2">Collect OS Disk Information</span><a href="#collect-os-disk-information" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p>The first step is to make sure the CVM the image is being created from is fully deallocated and then collect information about the OS disk. To do so we will need to know the resource group name, VM name, and region that the CVM is located in, we will set these as variables for easy reference.</p>

<div class="language-powershell highlighter-rouge"><div class="code-header">
        <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nv">$region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"North Europe"</span><span class="w">
</span><span class="nv">$resourceGroupName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"rg-custimg-lab-01"</span><span class="w">
</span><span class="nv">$vmName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"custcvm-01"</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>With the variables set, verify the VM is deallocated</p>

<div class="language-powershell highlighter-rouge"><div class="code-header">
        <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="c"># Deallocate the VM</span><span class="w">
</span><span class="n">az</span><span class="w"> </span><span class="nx">vm</span><span class="w"> </span><span class="nx">deallocate</span><span class="w"> </span><span class="nt">--name</span><span class="w"> </span><span class="nv">$vmname</span><span class="w"> </span><span class="nt">--resource-group</span><span class="w"> </span><span class="nv">$resourceGroupName</span><span class="w">

</span><span class="c"># Collect the OS Disk information</span><span class="w">
</span><span class="nv">$disk_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">az</span><span class="w"> </span><span class="nx">vm</span><span class="w"> </span><span class="nx">show</span><span class="w"> </span><span class="nt">--name</span><span class="w"> </span><span class="nv">$vmname</span><span class="w"> </span><span class="nt">--resource-group</span><span class="w"> </span><span class="nv">$resourceGroupName</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">jq</span><span class="w"> </span><span class="nt">-r</span><span class="w"> </span><span class="o">.</span><span class="nf">storageProfile</span><span class="o">.</span><span class="nf">osDisk</span><span class="o">.</span><span class="nf">name</span><span class="p">)</span><span class="w">
</span><span class="nv">$disk_url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">az</span><span class="w"> </span><span class="nx">disk</span><span class="w"> </span><span class="nx">grant-access</span><span class="w"> </span><span class="nt">--duration-in-seconds</span><span class="w"> </span><span class="nx">3600</span><span class="w"> </span><span class="nt">--name</span><span class="w"> </span><span class="nv">$disk_name</span><span class="w"> </span><span class="nt">--resource-group</span><span class="w"> </span><span class="nv">$resourceGroupName</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">jq</span><span class="w"> </span><span class="nt">-r</span><span class="w"> </span><span class="o">.</span><span class="nf">accessSas</span><span class="p">)</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h4 id="create-a-storage-account-for-the-vhd"><span class="me-2">Create a Storage Account for the VHD</span><a href="#create-a-storage-account-for-the-vhd" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p>Next, create a storage account, this will be used to store the exported VHD of the CVMs OS disk before it is uploaded to the Compute Gallery. For this part of the process, you will need to know the name of the Storage Account and Container that will be created.</p>

<div class="language-powershell highlighter-rouge"><div class="code-header">
        <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nv">$storageAccountName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"stgcvmvhd01"</span><span class="w">
</span><span class="nv">$storageContainerName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"cvmimages"</span><span class="w">
</span><span class="nv">$referenceVHD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"</span><span class="nv">${vmName}</span><span class="s2">.vhd"</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>Create the Storage Account and Container</p>

<div class="language-powershell highlighter-rouge"><div class="code-header">
        <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c"># Create Storage Account</span><span class="w">
</span><span class="n">az</span><span class="w"> </span><span class="nx">storage</span><span class="w"> </span><span class="nx">account</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nt">--resource-group</span><span class="w"> </span><span class="nv">${resourceGroupName}</span><span class="w"> </span><span class="nt">--name</span><span class="w"> </span><span class="nv">${storageAccountName}</span><span class="w"> </span><span class="nt">--location</span><span class="w"> </span><span class="nv">$region</span><span class="w"> </span><span class="nt">--sku</span><span class="w"> </span><span class="s2">"Standard_LRS"</span><span class="w">

</span><span class="c"># Create a container in the Storage Account</span><span class="w">
</span><span class="n">az</span><span class="w"> </span><span class="nx">storage</span><span class="w"> </span><span class="nx">container</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nt">--name</span><span class="w"> </span><span class="nv">$storageContainerName</span><span class="w"> </span><span class="nt">--account-name</span><span class="w"> </span><span class="nv">$storageAccountName</span><span class="w"> </span><span class="nt">--resource-group</span><span class="w"> </span><span class="nv">$resourceGroupName</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>With the Storage Account and Container created, generate a Shared Access Signature (SAS) token to upload the disk image to the container. Be sure to set the expiry date to a date in the future.</p>

<div class="language-powershell highlighter-rouge"><div class="code-header">
        <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="c"># Generate a SAS token for the container</span><span class="w">
</span><span class="nv">$container_sas</span><span class="o">=</span><span class="p">(</span><span class="n">az</span><span class="w"> </span><span class="nx">storage</span><span class="w"> </span><span class="nx">container</span><span class="w"> </span><span class="nx">generate-sas</span><span class="w"> </span><span class="nt">--name</span><span class="w"> </span><span class="nv">$storageContainerName</span><span class="w"> </span><span class="nt">--account-name</span><span class="w"> </span><span class="nv">$storageAccountName</span><span class="w"> </span><span class="nt">--auth-mode</span><span class="w"> </span><span class="nx">key</span><span class="w"> </span><span class="nt">--expiry</span><span class="w"> </span><span class="nx">2025-01-01</span><span class="w"> </span><span class="nt">--https-only</span><span class="w"> </span><span class="nt">--permissions</span><span class="w"> </span><span class="nx">dlrw</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="nx">tsv</span><span class="p">)</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>Using the SAS token and information collected, the VHD can now be exported to the Storage Account using AzCopy.</p>

<div class="language-powershell highlighter-rouge"><div class="code-header">
        <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c"># Build the Blob URL</span><span class="w">
</span><span class="nv">$blob_url</span><span class="o">=</span><span class="s2">"https://</span><span class="nv">${storageAccountName}</span><span class="s2">.blob.core.windows.net/</span><span class="nv">$storageContainerName</span><span class="s2">/</span><span class="nv">$referenceVHD</span><span class="s2">"</span><span class="w">

</span><span class="c"># Export the VHD using AzCopy</span><span class="w">
</span><span class="n">azcopy</span><span class="w"> </span><span class="nx">copy</span><span class="w"> </span><span class="s2">"</span><span class="nv">$disk_url</span><span class="s2">"</span><span class="w"> </span><span class="s2">"</span><span class="nv">${blob_url}</span><span class="s2">?</span><span class="nv">${container_sas}</span><span class="s2">"</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h3 id="upload-the-image-to-a-compute-gallery"><span class="me-2">Upload the Image to a Compute Gallery</span><a href="#upload-the-image-to-a-compute-gallery" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>With the VHD successfully exported to the Storage Account, the next step is to create an image definition in the Compute Gallery and upload the VHD to the gallery as a new version. For this part of the process, you will need to know the name of the Compute Gallery, Image Definition, Offer, Publisher, SKU, and Version number that will be created.</p>

<div class="language-powershell highlighter-rouge"><div class="code-header">
        <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nv">$galleryName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"acglabneu01"</span><span class="w">
</span><span class="nv">$imageDefinitionName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"cvmimage01"</span><span class="w">
</span><span class="nv">$OfferName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"offername01"</span><span class="w">
</span><span class="nv">$PublisherName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"pubname01"</span><span class="w">
</span><span class="nv">$SkuName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"skuname01"</span><span class="w">
</span><span class="nv">$galleryImageVersion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"1.0.0"</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>If a Compute Gallery does not already exist, create one using the following command, and create an Image Definition that has the required features and parameters set for Confidential VM support.</p>

<div class="language-powershell highlighter-rouge"><div class="code-header">
        <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c"># Create the Compute Gallery</span><span class="w">
</span><span class="n">az</span><span class="w"> </span><span class="nx">sig</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nt">--resource-group</span><span class="w"> </span><span class="nv">$resourceGroupName</span><span class="w"> </span><span class="nt">--gallery-name</span><span class="w"> </span><span class="nv">$galleryName</span><span class="w">

</span><span class="c"># Create the Image Definition</span><span class="w">
</span><span class="n">az</span><span class="w"> </span><span class="nx">sig</span><span class="w"> </span><span class="nx">image-definition</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nt">--resource-group</span><span class="w">  </span><span class="nv">$resourceGroupName</span><span class="w"> </span><span class="nt">--location</span><span class="w"> </span><span class="nv">$region</span><span class="w"> </span><span class="nt">--gallery-name</span><span class="w"> </span><span class="nv">$galleryName</span><span class="w"> </span><span class="nt">--gallery-image-definition</span><span class="w"> </span><span class="nv">$imageDefinitionName</span><span class="w"> </span><span class="nt">--publisher</span><span class="w"> </span><span class="nv">$PublisherName</span><span class="w"> </span><span class="nt">--offer</span><span class="w"> </span><span class="nv">$OfferName</span><span class="w"> </span><span class="nt">--sku</span><span class="w"> </span><span class="nv">$SkuName</span><span class="w"> </span><span class="nt">--os-type</span><span class="w"> </span><span class="nx">windows</span><span class="w"> </span><span class="nt">--os-state</span><span class="w"> </span><span class="nx">Generalized</span><span class="w"> </span><span class="nt">--hyper-v-generation</span><span class="w"> </span><span class="nx">V2</span><span class="w">  </span><span class="nt">--features</span><span class="w"> </span><span class="nx">SecurityType</span><span class="o">=</span><span class="n">ConfidentialVMSupported</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>To upload the VHD to the Compute Gallery, the ID of the Storage Account that contains tehVHD is required when creating the image version. This can be obtained using the following command.</p>

<div class="language-powershell highlighter-rouge"><div class="code-header">
        <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="c"># Get the Storage Account ID</span><span class="w">
</span><span class="nv">$storageAccountId</span><span class="o">=</span><span class="p">(</span><span class="n">az</span><span class="w"> </span><span class="nx">storage</span><span class="w"> </span><span class="nx">account</span><span class="w"> </span><span class="nx">show</span><span class="w"> </span><span class="nt">--name</span><span class="w"> </span><span class="nv">$storageAccountName</span><span class="w"> </span><span class="nt">--resource-group</span><span class="w"> </span><span class="nv">$resourceGroupName</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">jq</span><span class="w"> </span><span class="nt">-r</span><span class="w"> </span><span class="o">.</span><span class="nf">id</span><span class="p">)</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>With everything in place, the final step is to create the image version in the Compute Gallery using the VHD that was exported from the CVM.</p>

<div class="language-powershell highlighter-rouge"><div class="code-header">
        <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="c"># Create the Image Version</span><span class="w">
</span><span class="n">az</span><span class="w"> </span><span class="nx">sig</span><span class="w"> </span><span class="nx">image-version</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nt">--resource-group</span><span class="w"> </span><span class="nv">$resourceGroupName</span><span class="w"> </span><span class="nt">--gallery-name</span><span class="w"> </span><span class="nv">$galleryName</span><span class="w"> </span><span class="nt">--gallery-image-definition</span><span class="w"> </span><span class="nv">$imageDefinitionName</span><span class="w"> </span><span class="nt">--gallery-image-version</span><span class="w"> </span><span class="nv">$galleryImageVersion</span><span class="w"> </span><span class="nt">--os-vhd-storage-account</span><span class="w"> </span><span class="nv">$storageAccountId</span><span class="w"> </span><span class="nt">--os-vhd-uri</span><span class="w"> </span><span class="nv">$blob_url</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h3 id="the-full-image-export-process"><span class="me-2">The Full Image Export Process</span><a href="#the-full-image-export-process" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>Below is the full process to export the OS disk from the CVM, create the image, and upload it to the Compute Gallery.</p>

<div class="language-powershell highlighter-rouge"><div class="code-header">
        <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre></td><td class="rouge-code"><pre><span class="c"># Set Variables</span><span class="w">
</span><span class="nv">$region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"North Europe"</span><span class="w">
</span><span class="nv">$resourceGroupName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"rg-custimg-lab-01"</span><span class="w">
</span><span class="nv">$vmName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"custcvm-01"</span><span class="w">
</span><span class="nv">$storageAccountName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"stgcvmvhd01"</span><span class="w">
</span><span class="nv">$storageContainerName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"cvmimages"</span><span class="w">
</span><span class="nv">$referenceVHD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"</span><span class="nv">${vmName}</span><span class="s2">.vhd"</span><span class="w">
</span><span class="nv">$galleryName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"acglabneu01"</span><span class="w">
</span><span class="nv">$imageDefinitionName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"cvmimage01"</span><span class="w">
</span><span class="nv">$OfferName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"offername01"</span><span class="w">
</span><span class="nv">$PublisherName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"pubname01"</span><span class="w">
</span><span class="nv">$SkuName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"skuname01"</span><span class="w">
</span><span class="nv">$galleryImageVersion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"1.0.0"</span><span class="w">

</span><span class="c"># Deallocate the VM</span><span class="w">
</span><span class="n">az</span><span class="w"> </span><span class="nx">vm</span><span class="w"> </span><span class="nx">deallocate</span><span class="w"> </span><span class="nt">--name</span><span class="w"> </span><span class="nv">$vmName</span><span class="w"> </span><span class="nt">--resource-group</span><span class="w"> </span><span class="nv">$resourceGroupName</span><span class="w">

</span><span class="c"># Collect the OS Disk information</span><span class="w">
</span><span class="nv">$disk_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">az</span><span class="w"> </span><span class="nx">vm</span><span class="w"> </span><span class="nx">show</span><span class="w"> </span><span class="nt">--name</span><span class="w"> </span><span class="nv">$vmName</span><span class="w"> </span><span class="nt">--resource-group</span><span class="w"> </span><span class="nv">$resourceGroupName</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">jq</span><span class="w"> </span><span class="nt">-r</span><span class="w"> </span><span class="o">.</span><span class="nf">storageProfile</span><span class="o">.</span><span class="nf">osDisk</span><span class="o">.</span><span class="nf">name</span><span class="p">)</span><span class="w">
</span><span class="nv">$disk_url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">az</span><span class="w"> </span><span class="nx">disk</span><span class="w"> </span><span class="nx">grant-access</span><span class="w"> </span><span class="nt">--duration-in-seconds</span><span class="w"> </span><span class="nx">3600</span><span class="w"> </span><span class="nt">--name</span><span class="w"> </span><span class="nv">$disk_name</span><span class="w"> </span><span class="nt">--resource-group</span><span class="w"> </span><span class="nv">$resourceGroupName</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">jq</span><span class="w"> </span><span class="nt">-r</span><span class="w"> </span><span class="o">.</span><span class="nf">accessSas</span><span class="p">)</span><span class="w">

</span><span class="c"># Create Storage Account</span><span class="w">
</span><span class="n">az</span><span class="w"> </span><span class="nx">storage</span><span class="w"> </span><span class="nx">account</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nt">--resource-group</span><span class="w"> </span><span class="nv">${resourceGroupName}</span><span class="w"> </span><span class="nt">--name</span><span class="w"> </span><span class="nv">${storageAccountName}</span><span class="w"> </span><span class="nt">--location</span><span class="w"> </span><span class="nv">$region</span><span class="w"> </span><span class="nt">--sku</span><span class="w"> </span><span class="s2">"Standard_LRS"</span><span class="w">

</span><span class="c"># Create a container in the Storage Account</span><span class="w">
</span><span class="n">az</span><span class="w"> </span><span class="nx">storage</span><span class="w"> </span><span class="nx">container</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nt">--name</span><span class="w"> </span><span class="nv">$storageContainerName</span><span class="w"> </span><span class="nt">--account-name</span><span class="w"> </span><span class="nv">$storageAccountName</span><span class="w"> </span><span class="nt">--resource-group</span><span class="w"> </span><span class="nv">$resourceGroupName</span><span class="w">

</span><span class="c"># Generate a SAS token for the container</span><span class="w">
</span><span class="nv">$container_sas</span><span class="o">=</span><span class="p">(</span><span class="n">az</span><span class="w"> </span><span class="nx">storage</span><span class="w"> </span><span class="nx">container</span><span class="w"> </span><span class="nx">generate-sas</span><span class="w"> </span><span class="nt">--name</span><span class="w"> </span><span class="nv">$storageContainerName</span><span class="w"> </span><span class="nt">--account-name</span><span class="w"> </span><span class="nv">$storageAccountName</span><span class="w"> </span><span class="nt">--auth-mode</span><span class="w"> </span><span class="nx">key</span><span class="w"> </span><span class="nt">--expiry</span><span class="w"> </span><span class="nx">2025-01-01</span><span class="w"> </span><span class="nt">--https-only</span><span class="w"> </span><span class="nt">--permissions</span><span class="w"> </span><span class="nx">dlrw</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="nx">tsv</span><span class="p">)</span><span class="w">

</span><span class="c"># Build the Blob URL</span><span class="w">
</span><span class="nv">$blob_url</span><span class="o">=</span><span class="s2">"https://</span><span class="nv">${storageAccountName}</span><span class="s2">.blob.core.windows.net/</span><span class="nv">$storageContainerName</span><span class="s2">/</span><span class="nv">$referenceVHD</span><span class="s2">"</span><span class="w">

</span><span class="c"># Export the VHD using AzCopy</span><span class="w">
</span><span class="n">azcopy</span><span class="w"> </span><span class="nx">copy</span><span class="w"> </span><span class="s2">"</span><span class="nv">$disk_url</span><span class="s2">"</span><span class="w"> </span><span class="s2">"</span><span class="nv">${blob_url}</span><span class="s2">?</span><span class="nv">${container_sas}</span><span class="s2">"</span><span class="w">

</span><span class="c"># Create the Compute Gallery</span><span class="w">
</span><span class="n">az</span><span class="w"> </span><span class="nx">sig</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nt">--resource-group</span><span class="w"> </span><span class="nv">$resourceGroupName</span><span class="w"> </span><span class="nt">--gallery-name</span><span class="w"> </span><span class="nv">$galleryName</span><span class="w">

</span><span class="c"># Create the Image Definition</span><span class="w">
</span><span class="n">az</span><span class="w"> </span><span class="nx">sig</span><span class="w"> </span><span class="nx">image-definition</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nt">--resource-group</span><span class="w">  </span><span class="nv">$resourceGroupName</span><span class="w"> </span><span class="nt">--location</span><span class="w"> </span><span class="nv">$region</span><span class="w"> </span><span class="nt">--gallery-name</span><span class="w"> </span><span class="nv">$galleryName</span><span class="w"> </span><span class="nt">--gallery-image-definition</span><span class="w"> </span><span class="nv">$imageDefinitionName</span><span class="w"> </span><span class="nt">--publisher</span><span class="w"> </span><span class="nv">$PublisherName</span><span class="w"> </span><span class="nt">--offer</span><span class="w"> </span><span class="nv">$OfferName</span><span class="w"> </span><span class="nt">--sku</span><span class="w"> </span><span class="nv">$SkuName</span><span class="w"> </span><span class="nt">--os-type</span><span class="w"> </span><span class="nx">windows</span><span class="w"> </span><span class="nt">--os-state</span><span class="w"> </span><span class="nx">Generalized</span><span class="w"> </span><span class="nt">--hyper-v-generation</span><span class="w"> </span><span class="nx">V2</span><span class="w">  </span><span class="nt">--features</span><span class="w"> </span><span class="nx">SecurityType</span><span class="o">=</span><span class="n">ConfidentialVMSupported</span><span class="w">

</span><span class="c"># Get the Storage Account ID</span><span class="w">
</span><span class="nv">$storageAccountId</span><span class="o">=</span><span class="p">(</span><span class="n">az</span><span class="w"> </span><span class="nx">storage</span><span class="w"> </span><span class="nx">account</span><span class="w"> </span><span class="nx">show</span><span class="w"> </span><span class="nt">--name</span><span class="w"> </span><span class="nv">$storageAccountName</span><span class="w"> </span><span class="nt">--resource-group</span><span class="w"> </span><span class="nv">$resourceGroupName</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">jq</span><span class="w"> </span><span class="nt">-r</span><span class="w"> </span><span class="o">.</span><span class="nf">id</span><span class="p">)</span><span class="w">

</span><span class="c"># Create the Image Version</span><span class="w">
</span><span class="n">az</span><span class="w"> </span><span class="nx">sig</span><span class="w"> </span><span class="nx">image-version</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nt">--resource-group</span><span class="w"> </span><span class="nv">$resourceGroupName</span><span class="w"> </span><span class="nt">--gallery-name</span><span class="w"> </span><span class="nv">$galleryName</span><span class="w"> </span><span class="nt">--gallery-image-definition</span><span class="w"> </span><span class="nv">$imageDefinitionName</span><span class="w"> </span><span class="nt">--gallery-image-version</span><span class="w"> </span><span class="nv">$galleryImageVersion</span><span class="w"> </span><span class="nt">--os-vhd-storage-account</span><span class="w"> </span><span class="nv">$storageAccountId</span><span class="w"> </span><span class="nt">--os-vhd-uri</span><span class="w"> </span><span class="nv">$blob_url</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/confidential-compute/">Confidential Compute</a>
      </div>
    

    <!-- tags -->
    
      <div class="post-tags">
        <i class="fa fa-tags fa-fw me-1"></i>
        
          <a
            href="/tags/images/"
            class="post-tag no-text-decoration"
          >images</a>
        
      </div>
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a href="https://www.linkedin.com/sharing/share-offsite/?url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2FCreating-Confidentail-Compute-Images-from-CVMs%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin">
        <i class="fa-fw fab fa-linkedin"></i>
      </a>
    

      

      <a href="https://www.reddit.com/submit?url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2FCreating-Confidentail-Compute-Images-from-CVMs%2F&title=Create%20Confidential%20Compute%20Capable%20Custom%20Images%20from%20Windows%20CVMs%20-%20cocallaw" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Reddit" aria-label="Reddit">
        <i class="fa-fw fa-brands fa-square-reddit"></i>
      </a>
    

      

      <a href="https://www.facebook.com/sharer/sharer.php?title=Create%20Confidential%20Compute%20Capable%20Custom%20Images%20from%20Windows%20CVMs%20-%20cocallaw&u=http%3A%2F%2Flocalhost%3A4000%2Fposts%2FCreating-Confidentail-Compute-Images-from-CVMs%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook">
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a href="https://www.threads.net/intent/post?text=Create%20Confidential%20Compute%20Capable%20Custom%20Images%20from%20Windows%20CVMs%20-%20cocallaw%20http%3A%2F%2Flocalhost%3A4000%2Fposts%2FCreating-Confidentail-Compute-Images-from-CVMs%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Threads" aria-label="Threads">
        <i class="fa-fw fa-brands fa-square-threads"></i>
      </a>
    

      

      <a href="https://bsky.app/intent/compose?text=Create%20Confidential%20Compute%20Capable%20Custom%20Images%20from%20Windows%20CVMs%20-%20cocallaw%20http%3A%2F%2Flocalhost%3A4000%2Fposts%2FCreating-Confidentail-Compute-Images-from-CVMs%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Bluesky" aria-label="Bluesky">
        <i class="fa-fw fa-brands fa-bluesky"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted">
            <div class="access">
              <!-- Get 5 last posted/updated posts -->














  <section id="access-lastmod">
    <h2 class="panel-heading">Recently Updated</h2>
    <ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2">
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/Creating-Confidential-Compute-Capable-Custom-Images/">Creating Confidential Compute Capable Custom Images from Standard Windows VMs</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/Creating-Confidentail-Compute-Images-from-CVMs/">Create Confidential Compute Capable Custom Images from Windows CVMs</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/Automating-Container-Builds-for-Upstream-Changes/">Automating Container Builds with GitHub Actions for Upstream Changes</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/Export-Bitlocker-Keys-from-Entra/">Export BitLocker Keys from Entra with GraphPowerShell</a>
        </li>
      
    </ul>
  </section>
  <!-- #access-lastmod -->


              <!-- The trending tags list -->















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">Trending Tags</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/images/">images</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/automation/">Automation</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/azure/">azure</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/bitlocker/">bitlocker</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/crowdstrike/">crowdstrike</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/devops/">DevOps</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/entra/">entra</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/microsoft-graph/">microsoft-graph</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/powershell/">powershell</a>
      
    </div>
  </section>


            </div>

            
              
              



  <section id="toc-wrapper" class="d-none ps-0 pe-4">
    <h2 class="panel-heading ps-3 mb-2">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->















  

  

  

  

  

  

  

  
    










  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">Further Reading</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/Creating-Confidential-Compute-Capable-Custom-Images/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1736096400"
  data-df="ll"
  
>
  Jan  5, 2025
</time>

              <h4 class="pt-0 my-2">Creating Confidential Compute Capable Custom Images from Standard Windows VMs</h4>
              <div class="text-muted">
                <p>How to create a custom image from a standard VM that can be used to provision Azure Confidential Compute VMs in Azure.</p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/Creating-Confidential-Compute-Capable-Custom-Images/"
      class="btn btn-outline-primary"
      aria-label="Older"
    >
      <p>Creating Confidential Compute Capable Custom Images from Standard Windows VMs</p>
    </a>
  

  
    <a
      href="/posts/Automating-Container-Builds-for-Upstream-Changes/"
      class="btn btn-outline-primary"
      aria-label="Newer"
    >
      <p>Automating Container Builds with GitHub Actions for Upstream Changes</p>
    </a>
  
</nav>

            
              
              <!-- The comments switcher -->

  
  <!-- https://giscus.app/ -->
<script type="text/javascript">
  (function () {
    const origin = 'https://giscus.app';
    const lightTheme = 'light';
    const darkTheme = 'dark_dimmed';

    let initTheme = lightTheme;
    const html = document.documentElement;

    if (
      (html.hasAttribute('data-mode') &&
        html.getAttribute('data-mode') === 'dark') ||
      (!html.hasAttribute('data-mode') &&
        window.matchMedia('(prefers-color-scheme: dark)').matches)
    ) {
      initTheme = darkTheme;
    }

    let lang = 'en';if (lang.length > 2 && !lang.startsWith('zh')) {
      lang = lang.slice(0, 2);
    }

    let giscusAttributes = {
      src: 'https://giscus.app/client.js',
      'data-repo': 'cocallaw/cocallaw.github.io',
      'data-repo-id': 'R_kgDOMuW1lg',
      'data-category': 'Giscus',
      'data-category-id': 'DIC_kwDOMuW1ls4CjqPh',
      'data-mapping': 'pathname',
      'data-strict' : '0',
      'data-reactions-enabled': '1',
      'data-emit-metadata': '0',
      'data-theme': initTheme,
      'data-input-position': 'bottom',
      'data-lang': lang,
      'data-loading': 'lazy',
      crossorigin: 'anonymous',
      async: ''
    };

    let giscusScript = document.createElement('script');
    Object.entries(giscusAttributes).forEach(([key, value]) =>
      giscusScript.setAttribute(key, value)
    );
    document.getElementById('tail-wrapper').appendChild(giscusScript);

    addEventListener('message', (event) => {
      if (
        event.source === window &&
        event.data &&
        event.data.direction === ModeToggle.ID
      ) {const mode = event.data.message;
        const theme = mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme;

        const message = {
          setConfig: {
            theme: theme
          }
        };

        const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow;
        giscus.postMessage({ giscus: message }, origin);
      }
    });
  })();
</script>



            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>
    <time>2025</time>

    
      <a href="https://twitter.com/username">Corey Callaway</a>.
    

    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >Some rights reserved.</span>
    
  </p>

  <p>Using the <a
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="v7.1.0"
        href="https://github.com/cotes2020/jekyll-theme-chirpy"
        target="_blank"
        rel="noopener"
      >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center d-none">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">Trending Tags</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/images/">images</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/automation/">Automation</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/azure/">azure</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/bitlocker/">bitlocker</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/crowdstrike/">crowdstrike</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/devops/">DevOps</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/entra/">entra</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/microsoft-graph/">microsoft-graph</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/powershell/">powershell</a>
      
    </div>
  </section>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- JavaScripts -->
    <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.29.0/dist/tocbot.min.js"></script>







<script src="/assets/js/dist/post.min.js"></script>



<!-- Pageviews -->

  

  







    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: '/assets/js/data/search.json',
    searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{snippet}</p>  </article>',
    noResultsText: '<p class="mt-5">Oops! No results found.</p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }

      if (prop === 'tags') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
        }
      }
    }
  });
</script>

  </body>
</html>

