<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Creating Confidential Compute Capable Custom Images from Standard Windows VMs" /><meta name="author" content="Corey Callaway" /><meta property="og:locale" content="en" /><meta name="description" content="How to create a custom image from a standard VM that can be used to provision Azure Confidential Compute VMs in Azure." /><meta property="og:description" content="How to create a custom image from a standard VM that can be used to provision Azure Confidential Compute VMs in Azure." /><link rel="canonical" href="https://cocallaw.com/posts/Creating-Confidential-Compute-Capable-Custom-Images/" /><meta property="og:url" content="https://cocallaw.com/posts/Creating-Confidential-Compute-Capable-Custom-Images/" /><meta property="og:site_name" content="cocallaw" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2025-01-05T12:00:00-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Creating Confidential Compute Capable Custom Images from Standard Windows VMs" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@Corey Callaway" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Corey Callaway","url":"https://www.cocallaw.com/about/"},"dateModified":"2025-01-05T12:00:00-05:00","datePublished":"2025-01-05T12:00:00-05:00","description":"How to create a custom image from a standard VM that can be used to provision Azure Confidential Compute VMs in Azure.","headline":"Creating Confidential Compute Capable Custom Images from Standard Windows VMs","mainEntityOfPage":{"@type":"WebPage","@id":"https://cocallaw.com/posts/Creating-Confidential-Compute-Capable-Custom-Images/"},"url":"https://cocallaw.com/posts/Creating-Confidential-Compute-Capable-Custom-Images/"}</script><title>Creating Confidential Compute Capable Custom Images from Standard Windows VMs | cocallaw</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="cocallaw"><meta name="application-name" content="cocallaw"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=true" ></script> <script defer src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon='{"token": "b814618bb529402badb6aeea52009c22"}' ></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="https://ccblog-hxegfte6cpg4c7a3.z01.azurefd.net/general/profile.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">cocallaw</a><p class="site-subtitle fst-italic mb-0">Azure Tinkerings</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/cocallaw" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://www.linkedin.com/in/corey-callaway-1abbb227/" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Creating Confidential Compute Capable Custom Images from Standard Windows VMs</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link" aria-label="Search"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>Creating Confidential Compute Capable Custom Images from Standard Windows VMs</h1><p class="post-desc fw-light mb-4">How to create a custom image from a standard VM that can be used to provision Azure Confidential Compute VMs in Azure.</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1736096400" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Jan 5, 2025 </time> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://www.cocallaw.com/about/">Corey Callaway</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="767 words" > <em>4 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">Creating Confidential Compute Capable Custom Images from Standard Windows VMs</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">Creating Confidential Compute Capable Custom Images from Standard Windows VMs</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><h2 id="confidential-compute-and-custom-images"><span class="me-2">Confidential Compute and Custom Images</span><a href="#confidential-compute-and-custom-images" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Creating a custom image that can be used to create Azure Confidential Compute (ACC) VMs is similar to creating a standard custom image, but with a slight twist when it comes to how the image is captured. This post covers how to create a custom image that could be used to provision a new ACC VM using either Customer Managed Key (CMK) or Platform Managed Key (PMK) encryption in any Azure region that has ACC capable AMD VM SKUs.</p><p>It is important to use the proper settings when creating the VM used to generate the custom image and capture the custom image, so that settings and features such as BitLocker are not enabled, which would require additional steps before capturing and possibly cause issues when using the captured image to provision a new CVM.</p><p>The steps outlined below require that you have access to the Azure Subscriptions containing the resources, and the current version of <a href="https://learn.microsoft.com/powershell/azure/install-azure-powershell">Azure PowerShell</a> installed. Commands were tested using Azure PowerShell from a Powershell Core session.</p><h3 id="creating-the-vm-for-custom-image-capture"><span class="me-2">Creating the VM for Custom Image Capture</span><a href="#creating-the-vm-for-custom-image-capture" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ol><li><p>From the Azure Portal, Select <strong>Virtual Machine</strong> and <strong>Create New VM</strong></p><li><p>On the Instance Detail page set <strong>Security Type</strong> to <strong>Standard</strong>, and select a non-ACC VM SKU</p><p><a href="https://ccblog-hxegfte6cpg4c7a3.z01.azurefd.net/post-content/02-cvmcustimgstandard/instance-detail-page.png" class="popup img-link shimmer"><img src="https://ccblog-hxegfte6cpg4c7a3.z01.azurefd.net/post-content/02-cvmcustimgstandard/instance-detail-page.png" alt="Instance-Detail-Page" loading="lazy"></a></p><li><p>On the Disks tab, set <strong>Key Management</strong> to <strong>Platform-managed Key</strong> and leave <strong>Encryption at host</strong> unchecked</p><p><a href="https://ccblog-hxegfte6cpg4c7a3.z01.azurefd.net/post-content/02-cvmcustimgstandard/disks-tab.png" class="popup img-link shimmer"><img src="https://ccblog-hxegfte6cpg4c7a3.z01.azurefd.net/post-content/02-cvmcustimgstandard/disks-tab.png" alt="Disks-Tab" loading="lazy"></a></p><li><p>Once the Custom Image VM has been deployed, connect to the machine and perform any customization tasks required.</p><li><p>When all customizations are complete, run Sysprep with <strong>OOBE</strong>, <strong>Generalize</strong> and <strong>Shutdown</strong> selected</p><p><a href="https://ccblog-hxegfte6cpg4c7a3.z01.azurefd.net/post-content/02-cvmcustimgstandard/sysprep-dialog.png" class="popup img-link shimmer"><img src="https://ccblog-hxegfte6cpg4c7a3.z01.azurefd.net/post-content/02-cvmcustimgstandard/sysprep-dialog.png" alt="Sysprep-Dialog" loading="lazy"></a></p><li><p>Once Sysprep has completed, the VM is ready to be captured</p></ol><h3 id="capture-the-custom-image"><span class="me-2">Capture the Custom Image</span><a href="#capture-the-custom-image" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>From an Azure PowerShell session connected to the Subscription that contains the Custom Image VM, set the proper values for the variables <code class="language-plaintext highlighter-rouge">$vmName</code>, <code class="language-plaintext highlighter-rouge">$rgName</code>, <code class="language-plaintext highlighter-rouge">$location</code> and <code class="language-plaintext highlighter-rouge">$imageName</code>.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nv">$vmName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"customvm01"</span><span class="w">
</span><span class="nv">$rgNameCustImg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"rg-custom-img-01"</span><span class="w">
</span><span class="nv">$location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"North Europe"</span><span class="w">
</span><span class="nv">$imageName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"image-01"</span><span class="w">
</span></pre></table></code></div></div><p>With the variables set run the following commands to create a Manged Image resource from the OS disk of the Custom Image VM.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="c"># Verify that the VM is deallocated</span><span class="w">
</span><span class="n">Stop-AzVM</span><span class="w"> </span><span class="nt">-ResourceGroupName</span><span class="w"> </span><span class="nv">$rgNameCustImg</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nv">$vmName</span><span class="w"> </span><span class="nt">-Force</span><span class="w">

</span><span class="c"># Set the status of the VM to generalized</span><span class="w">
</span><span class="n">Set-AzVm</span><span class="w"> </span><span class="nt">-ResourceGroupName</span><span class="w"> </span><span class="nv">$rgNameCustImg</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nv">$vmName</span><span class="w"> </span><span class="nt">-Generalized</span><span class="w">

</span><span class="c"># Store the VM details in a variable</span><span class="w">
</span><span class="nv">$vm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzVM</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nv">$vmName</span><span class="w"> </span><span class="nt">-ResourceGroupName</span><span class="w"> </span><span class="nv">$rgNameCustImg</span><span class="w">

</span><span class="c"># Create the image configuration </span><span class="w">
</span><span class="nv">$imageConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-AzImageConfig</span><span class="w"> </span><span class="nt">-Location</span><span class="w"> </span><span class="nv">$location</span><span class="w"> </span><span class="nt">-SourceVirtualMachineId</span><span class="w"> </span><span class="nv">$vm</span><span class="o">.</span><span class="nf">Id</span><span class="w"> </span><span class="nt">-HyperVGeneration</span><span class="w"> </span><span class="nx">V2</span><span class="w">

</span><span class="c"># Create an image from the VM</span><span class="w">
</span><span class="n">New-AzImage</span><span class="w"> </span><span class="nt">-ImageName</span><span class="w"> </span><span class="nv">$imageName</span><span class="w"> </span><span class="nt">-ResourceGroupName</span><span class="w"> </span><span class="nv">$rgNameCustImg</span><span class="w"> </span><span class="nt">-Image</span><span class="w"> </span><span class="nv">$imageConfig</span><span class="w">
</span></pre></table></code></div></div><h3 id="importing-the-custom-image-into-azure-compute-gallery"><span class="me-2">Importing the Custom Image into Azure Compute Gallery</span><a href="#importing-the-custom-image-into-azure-compute-gallery" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="azure-portal"><span class="me-2">Azure Portal</span><a href="#azure-portal" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>In the Azure Compute Gallery create a new Image Definition, with the Security Type set to <strong>Trusted launch and confidential VM supported</strong></p><p>On the next page select the Managed Image Resource to import to the Compute Gallery for the Image Definition</p><h4 id="azure-powershell"><span class="me-2">Azure PowerShell</span><a href="#azure-powershell" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>To import the Managed Image into the Compute Gallery, there first needs to be a new Image Definition created and then the Managed Image imported as a new version of the image definition.</p><p>To create the new Image Definition, set the following variables</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="nv">$rgNameACG</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">"rg-compute-gallery-01"</span><span class="w">
</span><span class="nv">$location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"North Europe"</span><span class="w">
</span><span class="nv">$galleryName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"acgallery01"</span><span class="w">
</span><span class="nv">$galleryImageDefinitionName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Def01"</span><span class="w">
</span><span class="nv">$publisherName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Publisher01"</span><span class="w">
</span><span class="nv">$offerName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Offer01"</span><span class="w">
</span><span class="nv">$skuName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Win11-24H2"</span><span class="w">
</span><span class="nv">$description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Windows 11 24H2"</span><span class="w">
</span><span class="c"># Variables to set the features of the Image Definition</span><span class="w">
</span><span class="nv">$ConfidentialVMSupported</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{</span><span class="nx">Name</span><span class="o">=</span><span class="s1">'SecurityType'</span><span class="p">;</span><span class="nx">Value</span><span class="o">=</span><span class="s1">'TrustedLaunchAndConfidentialVmSupported'</span><span class="p">}</span><span class="w">
</span><span class="nv">$IsHibernateSupported</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{</span><span class="nx">Name</span><span class="o">=</span><span class="s1">'IsHibernateSupported'</span><span class="p">;</span><span class="nx">Value</span><span class="o">=</span><span class="s1">'False'</span><span class="p">}</span><span class="w">
</span><span class="nv">$features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@(</span><span class="nv">$ConfidentialVMSupported</span><span class="p">,</span><span class="nv">$IsHibernateSupported</span><span class="p">)</span><span class="w">
</span></pre></table></code></div></div><p>With the variables set, run the following command to create the new Image Definition in the Compute Gallery</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">New-AzGalleryImageDefinition</span><span class="w"> </span><span class="nt">-ResourceGroupName</span><span class="w"> </span><span class="nv">$rgNameACG</span><span class="w"> </span><span class="nt">-GalleryName</span><span class="w"> </span><span class="nv">$galleryName</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nv">$galleryImageDefinitionName</span><span class="w"> </span><span class="nt">-Location</span><span class="w"> </span><span class="nv">$location</span><span class="w"> </span><span class="nt">-Publisher</span><span class="w"> </span><span class="nv">$publisherName</span><span class="w"> </span><span class="nt">-Offer</span><span class="w"> </span><span class="nv">$offerName</span><span class="w"> </span><span class="nt">-Sku</span><span class="w"> </span><span class="nv">$skuName</span><span class="w"> </span><span class="nt">-OsState</span><span class="w"> </span><span class="s2">"Generalized"</span><span class="w"> </span><span class="nt">-OsType</span><span class="w"> </span><span class="s2">"Windows"</span><span class="w"> </span><span class="nt">-Description</span><span class="w"> </span><span class="nv">$description</span><span class="w"> </span><span class="nt">-Feature</span><span class="w"> </span><span class="nv">$features</span><span class="w"> </span><span class="nt">-HyperVGeneration</span><span class="w"> </span><span class="s2">"V2"</span><span class="w">
</span></pre></table></code></div></div><p>Now that there is an Image Definition in the Compute Gallery, the Managed Image that was created from the Custom Image VM can be imported as a version of the Image Definition. To do this, first the Resource ID of the Managed Image needs to be retrieved.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$imageRID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Get-AzImage</span><span class="w"> </span><span class="nt">-ResourceGroupName</span><span class="w"> </span><span class="nv">$rgNameCustImg</span><span class="w"> </span><span class="nt">-ImageName</span><span class="w"> </span><span class="nv">$imageName</span><span class="p">)</span><span class="o">.</span><span class="nf">Id</span><span class="w">
</span></pre></table></code></div></div><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nv">$rgNameACG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"rg-compute-gallery-01"</span><span class="w">
</span><span class="nv">$location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"North Europe"</span><span class="w">
</span><span class="nv">$galleryName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"acgallery01"</span><span class="w">
</span><span class="nv">$galleryImageDefinitionName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Def01"</span><span class="w">
</span><span class="nv">$galleryImageVersionName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"0.0.1"</span><span class="w">
</span><span class="nv">$sourceImageId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$imageRID</span><span class="w">
</span><span class="nv">$storageAccountType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Premium_LRS"</span><span class="w">
</span></pre></table></code></div></div><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">New-AzGalleryImageVersion</span><span class="w"> </span><span class="nt">-ResourceGroupName</span><span class="w"> </span><span class="nv">$rgNameACG</span><span class="w"> </span><span class="nt">-GalleryName</span><span class="w"> </span><span class="nv">$galleryName</span><span class="w"> </span><span class="nt">-GalleryImageDefinitionName</span><span class="w"> </span><span class="nv">$galleryImageDefinitionName</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nv">$galleryImageVersionName</span><span class="w"> </span><span class="nt">-Location</span><span class="w"> </span><span class="nv">$location</span><span class="w"> </span><span class="nt">-StorageAccountType</span><span class="w"> </span><span class="nv">$storageAccountType</span><span class="w"> </span><span class="nt">-SourceImageId</span><span class="w"> </span><span class="nv">$sourceImageId</span><span class="w">
</span></pre></table></code></div></div><p>Once the image has been imported and the new Definition created in the Compute Gallery, you can utilizes either the Resource ID of the new Image Definition as a parameter in a template file or create new Confidential VMs from the Compute Gallery using the Azure Portal.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/confidential-compute/">Confidential Compute</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/images/" class="post-tag no-text-decoration" >images</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fcocallaw.com%2Fposts%2FCreating-Confidential-Compute-Capable-Custom-Images%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <a href="https://www.reddit.com/submit?url=https%3A%2F%2Fcocallaw.com%2Fposts%2FCreating-Confidential-Compute-Capable-Custom-Images%2F&title=Creating%20Confidential%20Compute%20Capable%20Custom%20Images%20from%20Standard%20Windows%20VMs%20-%20cocallaw" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Reddit" aria-label="Reddit"> <i class="fa-fw fa-brands fa-square-reddit"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Creating%20Confidential%20Compute%20Capable%20Custom%20Images%20from%20Standard%20Windows%20VMs%20-%20cocallaw&u=https%3A%2F%2Fcocallaw.com%2Fposts%2FCreating-Confidential-Compute-Capable-Custom-Images%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.threads.net/intent/post?text=Creating%20Confidential%20Compute%20Capable%20Custom%20Images%20from%20Standard%20Windows%20VMs%20-%20cocallaw%20https%3A%2F%2Fcocallaw.com%2Fposts%2FCreating-Confidential-Compute-Capable-Custom-Images%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Threads" aria-label="Threads"> <i class="fa-fw fa-brands fa-square-threads"></i> </a> <a href="https://bsky.app/intent/compose?text=Creating%20Confidential%20Compute%20Capable%20Custom%20Images%20from%20Standard%20Windows%20VMs%20-%20cocallaw%20https%3A%2F%2Fcocallaw.com%2Fposts%2FCreating-Confidential-Compute-Capable-Custom-Images%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Bluesky" aria-label="Bluesky"> <i class="fa-fw fa-brands fa-bluesky"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/Export-Bitlocker-Keys-from-Entra/">Export BitLocker Keys from Entra with Graph PowerShell</a><li class="text-truncate lh-lg"> <a href="/posts/Automating-Container-Builds-for-Upstream-Changes/">Automating Container Builds with GitHub Actions for Upstream Changes</a><li class="text-truncate lh-lg"> <a href="/posts/Creating-Confidentail-Compute-Images-from-CVMs/">Create Confidential Compute Capable Custom Images from Windows CVMs</a><li class="text-truncate lh-lg"> <a href="/posts/Creating-Confidential-Compute-Capable-Custom-Images/">Creating Confidential Compute Capable Custom Images from Standard Windows VMs</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/images/">images</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">Automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/azure/">azure</a> <a class="post-tag btn btn-outline-primary" href="/tags/bitlocker/">bitlocker</a> <a class="post-tag btn btn-outline-primary" href="/tags/crowdstrike/">crowdstrike</a> <a class="post-tag btn btn-outline-primary" href="/tags/devops/">DevOps</a> <a class="post-tag btn btn-outline-primary" href="/tags/entra/">entra</a> <a class="post-tag btn btn-outline-primary" href="/tags/microsoft-graph/">microsoft-graph</a> <a class="post-tag btn btn-outline-primary" href="/tags/powershell/">powershell</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/Creating-Confidentail-Compute-Images-from-CVMs/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1736182800" data-df="ll" > Jan 6, 2025 </time><h4 class="pt-0 my-2">Create Confidential Compute Capable Custom Images from Windows CVMs</h4><div class="text-muted"><p>How to create a custom Windows image from an existing Windows CVM that can be used to provision Azure Confidential Compute VMs in Azure.</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"><div class="btn btn-outline-primary disabled" aria-label="Older"><p>-</p></div><a href="/posts/Creating-Confidentail-Compute-Images-from-CVMs/" class="btn btn-outline-primary" aria-label="Newer" ><p>Create Confidential Compute Capable Custom Images from Windows CVMs</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://twitter.com/username">Corey Callaway</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/images/">images</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">Automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/azure/">azure</a> <a class="post-tag btn btn-outline-primary" href="/tags/bitlocker/">bitlocker</a> <a class="post-tag btn btn-outline-primary" href="/tags/crowdstrike/">crowdstrike</a> <a class="post-tag btn btn-outline-primary" href="/tags/devops/">DevOps</a> <a class="post-tag btn btn-outline-primary" href="/tags/entra/">entra</a> <a class="post-tag btn btn-outline-primary" href="/tags/microsoft-graph/">microsoft-graph</a> <a class="post-tag btn btn-outline-primary" href="/tags/powershell/">powershell</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> (function () { const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed'); const initTheme = themeMapper[Theme.visualState]; let lang = 'en';if (lang.length > 2 && !lang.startsWith('zh')) { lang = lang.slice(0, 2); } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'cocallaw/cocallaw.github.io', 'data-repo-id': 'R_kgDOMuW1lg', 'data-category': 'Giscus', 'data-category-id': 'DIC_kwDOMuW1ls4CjqPh', 'data-mapping': 'pathname', 'data-strict' : '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': lang, 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusNode = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusNode.setAttribute(key, value) ); const $footer = document.querySelector('footer'); $footer.insertAdjacentElement("beforebegin", giscusNode); addEventListener('message', (event) => { if (event.source === window && event.data && event.data.id === Theme.ID) { const newTheme = themeMapper[Theme.visualState]; const message = { setConfig: { theme: newTheme } }; const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow; giscus.postMessage({ giscus: message }, 'https://giscus.app'); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{content}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
